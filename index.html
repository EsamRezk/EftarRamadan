<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¥ÙØ·Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ğŸŒ™</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --gold: #D4AF37;
    --gold-light: #F5D76E;
    --gold-dark: #9A7D0A;
    --navy: #0A0F2E;
    --navy-mid: #111736;
    --navy-light: #1a2050;
    --cream: #FFF8E7;
    --emerald: #1B6B4A;
    --text-light: #F0E6C8;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Tajawal', sans-serif;
    background: var(--navy);
    color: var(--text-light);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Stars background */
  .stars {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  .star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle var(--dur, 3s) infinite;
  }

  @keyframes twinkle {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.3); }
  }

  /* Decorative crescent */
  .crescent {
    position: fixed;
    top: -60px;
    left: -60px;
    width: 220px;
    height: 220px;
    border-radius: 50%;
    background: transparent;
    border: none;
    box-shadow: 50px 60px 0 var(--gold);
    opacity: 0.15;
    pointer-events: none;
    z-index: 0;
  }

  /* Islamic pattern overlay */
  .pattern-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    opacity: 0.03;
    background-image: 
      repeating-linear-gradient(45deg, var(--gold) 0px, var(--gold) 1px, transparent 1px, transparent 20px),
      repeating-linear-gradient(-45deg, var(--gold) 0px, var(--gold) 1px, transparent 1px, transparent 20px);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .card {
    background: linear-gradient(145deg, var(--navy-mid), var(--navy-light));
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 24px;
    padding: 50px 40px;
    max-width: 540px;
    width: 100%;
    box-shadow: 
      0 0 60px rgba(212, 175, 55, 0.08),
      0 20px 60px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(212, 175, 55, 0.2);
    animation: cardIn 0.6s ease-out;
  }

  @keyframes cardIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .gold-divider {
    width: 80px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    margin: 20px auto;
  }

  .icon-moon {
    font-size: 64px;
    text-align: center;
    display: block;
    margin-bottom: 10px;
    animation: float 3s ease-in-out infinite;
    filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.5));
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  h1 {
    font-family: 'Amiri', serif;
    font-size: 2.2rem;
    text-align: center;
    color: var(--gold);
    text-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
    line-height: 1.4;
  }

  .subtitle {
    text-align: center;
    color: rgba(240, 230, 200, 0.6);
    font-size: 0.95rem;
    margin-top: 8px;
  }

  .input-group {
    margin-top: 36px;
  }

  .input-group label {
    display: block;
    color: var(--gold-light);
    font-size: 0.9rem;
    margin-bottom: 10px;
    font-weight: 700;
    letter-spacing: 1px;
  }

  .input-group input {
    width: 100%;
    padding: 16px 20px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 12px;
    color: white;
    font-family: 'Tajawal', sans-serif;
    font-size: 1.1rem;
    outline: none;
    transition: all 0.3s;
    text-align: right;
  }

  .input-group input:focus {
    border-color: var(--gold);
    background: rgba(212, 175, 55, 0.08);
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.15);
  }

  .btn {
    width: 100%;
    padding: 18px;
    margin-top: 24px;
    background: linear-gradient(135deg, var(--gold-dark), var(--gold), var(--gold-light));
    color: var(--navy);
    border: none;
    border-radius: 12px;
    font-family: 'Tajawal', sans-serif;
    font-size: 1.1rem;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.3s;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  .btn:hover::before { left: 100%; }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4); }
  .btn:active { transform: translateY(0); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* Question screen */
  .question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }

  .q-badge {
    background: rgba(212, 175, 55, 0.15);
    border: 1px solid rgba(212, 175, 55, 0.4);
    color: var(--gold);
    padding: 6px 16px;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 700;
  }

  .progress-dots {
    display: flex;
    gap: 8px;
  }

  .dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: rgba(212, 175, 55, 0.2);
    border: 1px solid rgba(212, 175, 55, 0.3);
    transition: all 0.4s;
  }

  .dot.active {
    background: var(--gold);
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
  }

  .dot.done {
    background: var(--emerald);
    border-color: var(--emerald);
  }

  .question-text {
    font-family: 'Amiri', serif;
    font-size: 1.45rem;
    line-height: 1.7;
    color: var(--cream);
    margin-bottom: 30px;
    text-align: center;
    min-height: 90px;
  }

  .options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .option-btn {
    padding: 18px 14px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 14px;
    color: var(--text-light);
    font-family: 'Tajawal', sans-serif;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.25s;
    text-align: center;
    line-height: 1.4;
  }

  .option-btn:hover:not(:disabled) {
    background: rgba(212, 175, 55, 0.1);
    border-color: var(--gold);
    transform: scale(1.02);
  }

  .option-btn.correct {
    background: rgba(27, 107, 74, 0.4);
    border-color: #2ECC71;
    color: #2ECC71;
    animation: pulse-green 0.5s ease;
  }

  .option-btn.wrong {
    background: rgba(192, 57, 43, 0.3);
    border-color: #E74C3C;
    color: #E74C3C;
    animation: shake 0.4s ease;
  }

  .option-btn.reveal {
    background: rgba(27, 107, 74, 0.2);
    border-color: rgba(46, 204, 113, 0.4);
    color: rgba(46, 204, 113, 0.8);
  }

  @keyframes pulse-green {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(46,204,113,0.5); }
    100% { transform: scale(1); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }

  .feedback-msg {
    text-align: center;
    font-size: 1.1rem;
    font-weight: 700;
    min-height: 40px;
    padding: 10px;
    border-radius: 10px;
    transition: all 0.3s;
  }

  .feedback-msg.correct { color: #2ECC71; }
  .feedback-msg.wrong { color: #E74C3C; }

  /* Score display */
  .score-circles {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
  }

  .score-circle {
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
  }

  /* Invitation screen */
  .invitation-card {
    background: linear-gradient(145deg, rgba(212,175,55,0.1), rgba(212,175,55,0.03));
    border: 1px solid rgba(212, 175, 55, 0.5);
    border-radius: 20px;
    padding: 36px 28px;
    text-align: center;
    margin: 20px 0;
    position: relative;
    overflow: hidden;
  }

  .invitation-card::before {
    content: 'âœ¦';
    position: absolute;
    top: 12px; right: 16px;
    color: var(--gold);
    opacity: 0.4;
    font-size: 1.5rem;
  }

  .invitation-card::after {
    content: 'âœ¦';
    position: absolute;
    bottom: 12px; left: 16px;
    color: var(--gold);
    opacity: 0.4;
    font-size: 1.5rem;
  }

  .invitation-name {
    font-family: 'Amiri', serif;
    font-size: 1.8rem;
    color: var(--gold);
    margin-bottom: 6px;
  }

  .invitation-body {
    font-family: 'Amiri', serif;
    font-size: 1.1rem;
    line-height: 2;
    color: var(--cream);
  }

  .invitation-detail {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 12px 0;
    font-size: 1.05rem;
  }

  .invitation-detail .icon { font-size: 1.3rem; }
  .invitation-detail .detail-label { color: var(--gold-light); font-weight: 700; }
  .invitation-detail .detail-val { color: var(--cream); }

  /* Leaderboard */
  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .leaderboard-table th {
    color: var(--gold);
    font-size: 0.85rem;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(212,175,55,0.2);
    text-align: right;
  }

  .leaderboard-table td {
    padding: 12px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 0.95rem;
    color: var(--text-light);
  }

  .leaderboard-table tr:first-child td { color: var(--gold); font-weight: 700; }

  .rank-badge {
    display: inline-block;
    width: 28px; height: 28px;
    border-radius: 50%;
    text-align: center;
    line-height: 28px;
    font-size: 0.85rem;
    font-weight: 700;
  }

  .rank-1 { background: var(--gold); color: var(--navy); }
  .rank-2 { background: #A8A9AD; color: var(--navy); }
  .rank-3 { background: #CD7F32; color: white; }
  .rank-other { background: rgba(255,255,255,0.1); color: var(--text-light); }

  .screen { display: none; }
  .screen.active { display: block; }

  /* Tab buttons */
  .tab-row {
    display: flex;
    gap: 10px;
    margin-top: 24px;
  }

  .tab-btn {
    flex: 1;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 10px;
    color: var(--text-light);
    font-family: 'Tajawal', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s;
  }

  .tab-btn:hover, .tab-btn.active {
    background: rgba(212, 175, 55, 0.15);
    border-color: var(--gold);
    color: var(--gold);
  }

  .loading {
    text-align: center;
    padding: 30px;
    color: rgba(212, 175, 55, 0.6);
    font-size: 0.95rem;
  }

  .confetti-container {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 100;
  }

  .confetti-piece {
    position: absolute;
    width: 8px; height: 8px;
    border-radius: 2px;
    animation: confettiFall linear forwards;
    top: -10px;
  }

  @keyframes confettiFall {
    to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
  }

  /* Setup instructions */
  .setup-box {
    background: rgba(212,175,55,0.05);
    border: 1px dashed rgba(212,175,55,0.3);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    font-size: 0.85rem;
    color: rgba(240,230,200,0.7);
    line-height: 1.8;
  }

  .setup-box code {
    background: rgba(0,0,0,0.3);
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--gold-light);
    font-size: 0.8rem;
  }
</style>
</head>
<body>

<!-- Stars -->
<div class="stars" id="stars"></div>
<div class="crescent"></div>
<div class="pattern-overlay"></div>
<div class="confetti-container" id="confetti"></div>

<div class="container">
  <div class="card">

    <!-- SCREEN 1: Welcome -->
    <div class="screen active" id="screen-welcome">
      <span class="icon-moon">ğŸŒ™</span>
      <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¥ÙØ·Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
      <div class="gold-divider"></div>
      <p class="subtitle">Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ… Â· Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¯ÙŠÙ†ÙŠØ©</p>

      <div class="input-group">
        <label>âœ¦ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</label>
        <input type="text" id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…..." maxlength="30" />
      </div>

      <button class="btn" id="startBtn" onclick="startQuiz()">
        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© âœ¨
      </button>

      <div class="tab-row" id="leaderboardBtnRow" style="display:none;">
        <button class="tab-btn" onclick="showLeaderboard()">ğŸ† Ù†ØªØ§ÙŠØ¬ Ø§Ù„Ø¬Ù…ÙŠØ¹ ğŸ‘‘</button>
      </div>
    </div>

    <!-- SCREEN 2: Question -->
    <div class="screen" id="screen-question">
      <div class="question-header">
        <div class="q-badge" id="qBadge">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 3</div>
        <div class="progress-dots">
          <div class="dot active" id="dot-0"></div>
          <div class="dot" id="dot-1"></div>
          <div class="dot" id="dot-2"></div>
        </div>
      </div>

      <div class="question-text" id="questionText"></div>

      <div class="options-grid" id="optionsGrid"></div>

      <div class="feedback-msg" id="feedbackMsg"></div>

      <div class="score-circles" id="scoreCircles"></div>
    </div>

    <!-- SCREEN 3: Result + Invitation -->
    <div class="screen" id="screen-result">
      <span class="icon-moon">ğŸ‰</span>
      <h1 id="resultTitle">Ø£Ø­Ø³Ù†Øª!</h1>
      <div class="gold-divider"></div>

      <div class="score-big" id="scoreBig" style="text-align:center; font-size:3rem; color:var(--gold); margin:10px 0;"></div>
      <p style="text-align:center; color:rgba(240,230,200,0.6); font-size:0.9rem;">Ù…Ù† 3 Ø£Ø³Ø¦Ù„Ø©</p>

      <div class="invitation-card" id="invitationCard">
        <div class="invitation-name" id="invName"></div>
        <div class="invitation-body">
          ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø¯Ø¹ÙˆØªÙƒ Ù„Ø¥ÙØ·Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
          <br>
          <div class="invitation-detail">
            <span class="icon">ğŸ“…</span>
            <span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
            <span class="detail-val">Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù¢Ù£ ÙØ¨Ø±Ø§ÙŠØ± Ù¢Ù Ù¢Ù¥</span>
          </div>
          <div class="invitation-detail">
            <span class="icon">ğŸ•Œ</span>
            <span class="detail-label">Ø§Ù„Ù…ÙƒØ§Ù†:</span>
            <span class="detail-val">ÙÙ†Ø¯Ù‚ ALMA</span>
          </div>
          <div class="invitation-detail">
            <span class="icon">ğŸŒ™</span>
            <span class="detail-label">Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:</span>
            <span class="detail-val">Ø¥ÙØ·Ø§Ø± Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</span>
          </div>
        </div>
      </div>

      <button class="btn" onclick="shareInvitation()">ğŸ“¤ Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¯Ø¹ÙˆØ©</button>
      <div class="tab-row">
        <button class="tab-btn" id="resultLeaderboardBtn" style="display:none;" onclick="showLeaderboard()">ğŸ† Ù†ØªØ§ÙŠØ¬ Ø§Ù„Ø¬Ù…ÙŠØ¹ ğŸ‘‘</button>
        <button class="tab-btn" onclick="resetQuiz()">ğŸ”„ Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©</button>
      </div>
    </div>

    <!-- SCREEN 4: Leaderboard -->
    <div class="screen" id="screen-leaderboard">
      <h1 style="font-size:1.8rem;">ğŸ† Ù†ØªØ§ÙŠØ¬ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
      <div class="gold-divider"></div>
      <div id="leaderboardContent" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div class="tab-row">
        <button class="tab-btn" onclick="showScreen('screen-welcome')">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="tab-btn" onclick="loadLeaderboard()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

  </div>
</div>

<script>
// ============================================================
// ğŸ‘‘ ADMIN - Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù„ÙŠ ÙŠØ´ÙˆÙ Ù†ØªØ§ÙŠØ¬ Ø§Ù„ÙƒÙ„
// ============================================================
const ADMIN_NAME = 'MahmoudKabbo';
// ============================================================
const SUPABASE_URL = 'https://tnbyvzjrtmaetnhjzyvs.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuYnl2empydG1hZXRuaGp6eXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NTc2ODEsImV4cCI6MjA4NzMzMzY4MX0.d5ckc7mZReCNQk-e89_kNNgjjvuBkMxWdtpccifQz6E';
// ============================================================

let sbClient = null;
let useDB = false;

try {
  if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
    sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    useDB = true;
  }
} catch(e) {}

// State
let currentQ = 0;
let score = 0;
let userName = '';
let answers = [];
let answered = false;

// Questions
const questions = [
  {
    q: "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ Ø£ÙÙ†Ø²Ù„ ÙÙŠÙ‡ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ",
    options: ["Ø´Ø¹Ø¨Ø§Ù†", "Ø±Ù…Ø¶Ø§Ù†", "Ù…Ø­Ø±Ù‘Ù…", "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©"],
    correct: 1,
    explanation: "Ù‚Ø§Ù„ ØªØ¹Ø§Ù„Ù‰: ï´¿Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠ Ø£ÙÙ†Ø²ÙÙ„Ù ÙÙÙŠÙ‡Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ùï´¾ Ø§Ù„Ø¨Ù‚Ø±Ø©:185"
  },
  {
    q: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªÙŠ ØªÙØµÙ„Ù‘Ù‰ Ù…Ù†ÙØ±Ø¯Ø©Ù‹ ÙÙŠ Ø±Ù…Ø¶Ø§Ù† ÙˆØªÙØ³Ù…Ù‘Ù‰ ØµÙ„Ø§Ø© Ø§Ù„Ù‚ÙŠØ§Ù…ØŸ",
    options: ["Ø§Ù„ÙˆØªØ±", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­", "Ø§Ù„Ø§Ø³ØªØ®Ø§Ø±Ø©"],
    correct: 2,
    explanation: "ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­ Ø³Ù†Ù‘Ø©ÙŒ Ù…Ø¤ÙƒØ¯Ø©ØŒ ÙˆÙ‚Ø¯ Ø¬Ù…Ø¹ Ø§Ù„Ù†Ø§Ø³Ù Ø¹Ù„ÙŠÙ‡Ø§ Ø³ÙŠØ¯Ù†Ø§ Ø¹Ù…Ø± Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡"
  },
  {
    q: "Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠÙÙØ·Ø± Ø¨Ù‡ Ø§Ù„Ù…Ø³Ù„Ù… ÙÙŠ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ© Ø§Ù„Ø´Ø±ÙŠÙØ©ØŸ",
    options: ["Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ØªÙ…Ø±", "Ø§Ù„ØªÙ…Ø± ÙˆØ§Ù„Ø­Ù„ÙŠØ¨", "Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„Ø­Ù„ÙŠØ¨", "Ø§Ù„Ø±Ø·Ø¨ ÙˆØ§Ù„ØªÙ…Ø±"],
    correct: 0,
    explanation: "Ù‚Ø§Ù„ Ø§Ù„Ù†Ø¨ÙŠ ï·º: Â«Ø¥Ø°Ø§ Ø£ÙØ·Ø± Ø£Ø­Ø¯ÙƒÙ… ÙÙ„ÙŠÙØ·Ø± Ø¹Ù„Ù‰ ØªÙ…Ø±ØŒ ÙØ¥Ù† Ù„Ù… ÙŠØ¬Ø¯ ÙÙ„ÙŠÙØ·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ø¡Â»"
  }
];

// Generate stars
function generateStars() {
  const container = document.getElementById('stars');
  for (let i = 0; i < 80; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random() * 2.5 + 0.5;
    s.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random()*100}%;
      top:${Math.random()*100}%;
      --dur:${Math.random()*4+2}s;
      animation-delay:${Math.random()*4}s;
    `;
    container.appendChild(s);
  }
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startQuiz() {
  const name = document.getElementById('nameInput').value.trim();
  if (!name) {
    document.getElementById('nameInput').style.borderColor = '#E74C3C';
    document.getElementById('nameInput').placeholder = 'âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ';
    return;
  }
  userName = name;

  // Show leaderboard button only for admin on welcome screen
  const isAdmin = name === ADMIN_NAME;
  document.getElementById('leaderboardBtnRow').style.display = isAdmin ? 'flex' : 'none';

  // If admin just typed name and wants leaderboard directly - allow from welcome
  currentQ = 0;
  score = 0;
  answers = [];
  loadQuestion();
  showScreen('screen-question');
}

function loadQuestion() {
  const q = questions[currentQ];
  answered = false;
  document.getElementById('qBadge').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQ + 1} Ù…Ù† ${questions.length}`;
  document.getElementById('questionText').textContent = q.q;
  document.getElementById('feedbackMsg').textContent = '';
  document.getElementById('feedbackMsg').className = 'feedback-msg';

  // Update dots
  for (let i = 0; i < questions.length; i++) {
    const dot = document.getElementById(`dot-${i}`);
    dot.className = 'dot';
    if (i < currentQ) dot.classList.add('done');
    if (i === currentQ) dot.classList.add('active');
  }

  // Score circles
  const sc = document.getElementById('scoreCircles');
  sc.innerHTML = answers.map((a, i) =>
    `<div class="score-circle" style="background:${a?'rgba(27,107,74,0.5)':'rgba(192,57,43,0.3)'}; border: 1px solid ${a?'#2ECC71':'#E74C3C'}">${a?'âœ…':'âŒ'}</div>`
  ).join('');

  // Options
  const grid = document.getElementById('optionsGrid');
  grid.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = opt;
    btn.onclick = () => selectAnswer(i, btn);
    grid.appendChild(btn);
  });
}

function selectAnswer(idx, btnEl) {
  if (answered) return;
  answered = true;

  const q = questions[currentQ];
  const btns = document.querySelectorAll('.option-btn');
  btns.forEach(b => b.disabled = true);

  const isCorrect = idx === q.correct;
  if (isCorrect) {
    score++;
    btnEl.classList.add('correct');
    document.getElementById('feedbackMsg').textContent = 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø£Ø­Ø³Ù†Øª';
    document.getElementById('feedbackMsg').className = 'feedback-msg correct';
  } else {
    btnEl.classList.add('wrong');
    btns[q.correct].classList.add('reveal');
    document.getElementById('feedbackMsg').textContent = `âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.options[q.correct]}`;
    document.getElementById('feedbackMsg').className = 'feedback-msg wrong';
  }

  answers.push(isCorrect);

  setTimeout(() => {
    currentQ++;
    if (currentQ < questions.length) {
      loadQuestion();
    } else {
      showResult();
    }
  }, 1800);
}

async function showResult() {
  const titles = ['Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰! ğŸ’ª', 'Ù…Ù…ØªØ§Ø²! Ø£Ø­Ø³Ù†Øª ğŸ‘', 'Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹! ğŸŒŸ', 'Ù…Ø«Ø§Ù„ÙŠ! Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! ğŸ†'];
  document.getElementById('resultTitle').textContent = titles[score];
  document.getElementById('scoreBig').textContent = `${score} / ${questions.length}`;
  document.getElementById('invName').textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${userName} ğŸŒ™`;

  showScreen('screen-result');

  // Show leaderboard button only for MahmoudKabbo
  const isAdmin = userName === ADMIN_NAME;
  const lbBtn = document.getElementById('resultLeaderboardBtn');
  if (lbBtn) lbBtn.style.display = isAdmin ? 'block' : 'none';

  if (score === questions.length) {
    launchConfetti();
  }

  // Save to DB
  if (useDB) {
    try {
      await sbClient.from('quiz_results').insert({
        name: userName,
        score: score,
        total: questions.length,
        created_at: new Date().toISOString()
      });
    } catch(e) { console.log('DB save error', e); }
  } else {
    // Local storage fallback
    const results = JSON.parse(localStorage.getItem('quiz_results') || '[]');
    results.push({ name: userName, score, total: questions.length, created_at: new Date().toISOString() });
    localStorage.setItem('quiz_results', JSON.stringify(results));
  }
}

async function showLeaderboard() {
  if (userName !== ADMIN_NAME) {
    // Block access for non-admins even if somehow called
    return;
  }
  showScreen('screen-leaderboard');
  await loadLeaderboard();
}

async function loadLeaderboard() {
  const el = document.getElementById('leaderboardContent');
  el.innerHTML = '<div class="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

  let results = [];

  if (useDB) {
    try {
      const { data, error } = await sbClient
        .from('quiz_results')
        .select('*')
        .order('score', { ascending: false })
        .order('created_at', { ascending: true });
      if (!error) results = data || [];
    } catch(e) {}
  } else {
    results = JSON.parse(localStorage.getItem('quiz_results') || '[]');
    results.sort((a,b) => b.score - a.score || new Date(a.created_at) - new Date(b.created_at));
  }

  if (results.length === 0) {
    el.innerHTML = '<p style="text-align:center; color:rgba(240,230,200,0.4); padding:30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ ğŸŒ™<br>ÙƒÙ† Ø£ÙˆÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†!</p>';
    return;
  }

  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const rankClass = (i) => i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other';

  el.innerHTML = `
    <table class="leaderboard-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
        </tr>
      </thead>
      <tbody>
        ${results.map((r, i) => `
          <tr>
            <td><span class="rank-badge ${rankClass(i)}">${i < 3 ? medals[i] : i+1}</span></td>
            <td>${escHtml(r.name)}</td>
            <td style="color:${r.score===3?'var(--gold)':r.score===2?'#2ECC71':'rgba(240,230,200,0.7)'}">${r.score} / ${r.total} ${'â­'.repeat(r.score)}</td>
            <td style="font-size:0.8rem; opacity:0.6;">${formatDate(r.created_at)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    ${!useDB ? '<p style="text-align:center; margin-top:16px; font-size:0.8rem; color:rgba(212,175,55,0.5);">âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·</p>' : ''}
  `;
}

function formatDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  return dt.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function resetQuiz() {
  document.getElementById('nameInput').value = '';
  showScreen('screen-welcome');
}

function shareInvitation() {
  const text = `ğŸŒ™ Ø¥ÙØ·Ø§Ø± Ø¹Ø§Ø¦Ù„Ø© Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ\n\nØ£Ù‡Ù„Ø§Ù‹ ${userName}!\nØ£Ù†Øª Ù…Ø¯Ø¹Ùˆ Ù„Ø¥ÙØ·Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ğŸ‰\n\nğŸ“… Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù¢Ù£ ÙØ¨Ø±Ø§ÙŠØ± Ù¢Ù Ù¢Ù¥\nğŸ¨ ÙÙ†Ø¯Ù‚ ALMA\n\nÙ†ØªÙŠØ¬ØªÙŠ: ${score}/${questions.length} â­`;
  if (navigator.share) {
    navigator.share({ text });
  } else {
    navigator.clipboard.writeText(text).then(() => {
      alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¯Ø¹ÙˆØ©! Ø´Ø§Ø±ÙƒÙ‡Ø§ Ù…Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©');
    });
  }
}

function launchConfetti() {
  const colors = ['#D4AF37','#F5D76E','#2ECC71','#3498DB','#E74C3C','#9B59B6'];
  const container = document.getElementById('confetti');
  for (let i = 0; i < 80; i++) {
    const c = document.createElement('div');
    c.className = 'confetti-piece';
    c.style.cssText = `
      left:${Math.random()*100}%;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      animation-duration:${Math.random()*2+1.5}s;
      animation-delay:${Math.random()*1}s;
      width:${Math.random()*10+4}px;
      height:${Math.random()*10+4}px;
      border-radius:${Math.random()>0.5?'50%':'2px'};
    `;
    container.appendChild(c);
    setTimeout(() => c.remove(), 4000);
  }
}

// Also allow admin to check leaderboard from welcome screen by revealing button on name input
document.getElementById('nameInput').addEventListener('input', function() {
  const val = this.value.trim();
  const isAdmin = val === ADMIN_NAME;
  document.getElementById('leaderboardBtnRow').style.display = isAdmin ? 'flex' : 'none';
  if (isAdmin) userName = val; // set so leaderboard guard passes
});

// Init
generateStars();
</script>

</body>
</html>
